# Docker role

## How to use

The directory structure follow [Ansible Best Practices]("http://docs.ansible.com/ansible/latest/playbooks_best_practices.html#directory-layout") and it's
highly recomended to continue to use this role in the same way.

The inventory file is not provided for obvious reasons. It is up to you to define yours. It should be place alongside with the `roles` directory. By default `Ansible` will look for inventory at `/etc/ansible/hosts` and for roles at `/etc/ansible/roles`. As you will probably not setup your role at this location you need to instruct ansible where to look for inventory and roles are.

Ansible store its configuration under `/etc/ansible/ansible.cfg`, this file is system wide so if your are not the only who uses the remote host you must create a configuration file for your user. Copy the system wide file to your `$HOME`

```bash
cp /etc/ansible/ansible.cfg ~/.ansible.cfg
```

Then you'll need to edit `~/.ansible.cfg` and tell `Ansible` where to look for roles and inventory. Modify the following variables

```
...
inventory= <your_inventory_path>
...
roles_path= <your_roles_path>
``` 

You'll also need a way to handle passwords. Refer to section [How to handle passwords](#password)

The role comes with some defaults defined in `defaults/main.yaml`. DO NOT EDIT THIS FILE!!
If you need to modify some settings, override variables in `vars/main.yaml` or at role, task level.

## How to run

Here is an example of a `playbook` to install docker. 

```yaml
---

- name: Install docker
  hosts: <your_group_name>
  roles: 
    - docker  
```

Before running the command, be sure you configure your vault to manage your passwords. This is the only method presented here.

```bash
ansible-playbook -s docker.yaml --ask-vault-password
``` 

In case you don't use vault refer to the [official documentation]("http://docs.ansible.com/ansible/latest/intro_inventory.html") to find alternatives ways.

## What it does

Docker role will install docker on all hosts of specified in inventory. The role can handle `red hat` family host as well as `debian`.
* Add the latest docker repository and possibly legacy repository
* Uninstall old versions of docker 
* Install specified version
* Configure the daemon

### Tasks directory structure

```
├── debian                                                                                                                                 
│   └── main.yaml                                                                                                                          
├── main.yaml                                                                                                                               
└── redhat                                                                                                                                                    ├── add_legacy_repo.yaml                                                                                                                
    ├── main.yaml                       
    └── yum_config.yaml
```
* `main.yaml`: will include `debian/main.yaml` or `redhat/main.yaml` depending the linux distribution to perform distribution specific tasks. It will also perform all common tasks to all distributions (like setuping the `daemon`).
* `debian/main.yaml`: Install `Docker` through `apt` package manager.
* `redhat/main.yaml`: Install `Docker` through `yum` package manager.
* `redhat/add_legacy_repo.yaml`: Install the legacy repository
* `redhat/yum_config.yaml`: Modify yum.conf if variable `allow_legacy_versions` is set to `true`. (Default is `false`)

### Install latest repositories

For `Debian` Family:
```yaml
- name: "Install docker package: {{ docker_package }}"
  apt:
    name: "{{ docker_package }}"
    state: present
    update_cache: yes
```

For `Red Hat` Family:
```yaml
- name: "Install docker package: {{ docker_package }}"
  yum:
    name: "{{ docker_package }}"
    state: present
    update_cache: true
```

### Install legacy repositories

The role can install the latest version or a specific version depending on variable `allow_legacy_versions`. By default, legacy versions are not allowed.
In case `allow_legacy_versions` is set to `true` then a legacy repository is be added before installing and for `Red Hat` Family the file `yum.conf` must be changed to handle obsolete versions. This is done by the task defined in `yum_config.yaml`

```yaml
- name: Copy yum.conf with modified options
  template: 
        src: "{{ ansible_os_family|lower }}/yum.conf.j2"
        dest: /etc/yum.conf
        owner: root
        group: root
        mode: "u=rw"
```

This file will modify the template `templates/yum.conf.j2` and copy it to `/etc/yum.conf`

```python
[main]
cachedir=/var/cache/yum/$basearch/$releasever
keepcache=0
debuglevel=2
logfile=/var/log/yum.log
exactarch=1
{% if allow_legacy_versions  %}
obsoletes=1
{% else %}
obsoletes=0
{% endif %}
gpgcheck=1
plugins=1
installonly_limit=3

# PUT YOUR REPOS HERE OR IN separate files named file.repo
# in /etc/yum.repos.d
```
If you need to change the repositories urls you can do it in `vars/main.yaml`. Do not edit directly `defaults/main.yaml`. (cf. [Defaults](#defaults))

**Important Note:**

`For Debian family it seems that legacy repository is down.`

Red Hat Family:
```yaml
# package_name-version
docker_package: docker-ce-17.03.0
```
To know avalaible versions you can run:
```sh
yum list docker-ce --showduplicates

# for legacy versions
yum list docker-engine --showduplicates
```

Debian Family:
```yaml
# package_name=version
docker_package: docker-ce=17.03.0~ce-0~ubuntu-xenial
```
To know avalaible versions you can run:
```sh
apt-cache madison docker-ce

# for legacy versions
apt-cache madison docker-engine
```

# Uninstall old docker versions

As recomended by [Docker.Inc]("https://docs.docker.com/engine/installation/linux/docker-ce/centos/") old versions and related packages must be removed.

## Configure the daemon

```
TODO
```

## Role dependencies

```
TODO
```

## How to test

Sure, you can test it in a virtual machine but maybe the easiest way is to run a `docker` container with `sshd` installed.
There is a `Dockerfile` for both `Debian` and `Red Hat` families under `test/debian/` and `test/redhat`.

## <a name="password"></a> How to handle passwords 

Ansible must know the password to connect to the remote host as well as the `sudo` password. You can specify it several levels:
* Inventory
* Groups Vars
* Host Vars
* Roles
* Plays
* Tasks

You can specify those password in plain text but it is not recommended at all. It worth to have a look at `ansible-vault` to handle secrets.
Basically, you will define your password in a file e.g `groups_var/<group_name>` and encrypt it

```bash
# new file
ansible-vault create  groups_var/<group_name>

# existing file
ansible-vault envrypt create  groups_var/<group_name>

# modify an encrypted file
ansible-vault edit  groups_var/<group_name>
```

```
TO BE COMPLETED 
```

For further information, refer to : [Ansible Vault]("http://docs.ansible.com/ansible/latest/playbooks_vault.html")

## What can be changed

All defaults can be overrident. Some doesn't make sense to change like `yum` or `apt` current repositories but others can have value. Here is what you can override.

* **docker_package** The full package name to install. default is `docker-ce`
* **allow_legacy_versions** Allow legacy repositories. The role will install them for you. In this case you may also want to change
    * **yum_legacy_repository_url**
    * **yum_legacy_repository_gpg**
    * **apt_repository**
* **enable_docker_proxy** Will configure the daemon to use a proxy if your are behing one.
* **add_user_to_docker_group** if you want to use `docker` without `sudo`

## <a name="defaults"></a> Defaults 

Defaults resides under `defaults/main.yaml`. Defaults are the last place where `Ansible` will search for information. This file is not meant to be edited, if you need to override some variables defined in there, you should defined them on `vars/main.yaml`. 

If you need to override a variable to a specific task, you can also override it at task level.

```yaml
######## YUM #################
# current docker repository url for redhat family distributions
yum_recent_repository_source_url: "https://download.docker.com/linux/centos/docker-ce.repo"

# legacy repository
yum_legacy_repository_url: "https://yum.dockerproject.org/repo/main/centos/7"
yum_legacy_repository_gpg: "https://yum.dockerproject.org/gpg"
###############################

######## APT ##################
# ce to get apt repository key
apt_key_url: "https://download.docker.com/linux/ubuntu/gpg"
# apt repository key signature

# Name of the apt repository for Docker CE
apt_repository: "deb [arch=amd64] https://download.docker.com/linux/{{ ansible_lsb.id|lower }} {{ ansible_lsb.codename|lower }} stable"
################################

# for redhat family docker-ce-version
# for debian family docker-ce=version
docker_package: docker-ce

# if true then legacy repositories can be added
allow_legacy_versions: true

# use http proxy with docker
enable_docker_proxy: false

# add user to docker group
add_user_to_docker_group: false

```